/*
 * blancoDb
 * Copyright (C) 2004-2006 Yasuo Nakanishi
 *
 * This library is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 2.1 of the License, or (at your option) any later version.
 */
package blanco.db.util;

import blanco.cg.BlancoCgObjectFactory;
import blanco.cg.valueobject.*;
import blanco.commons.util.BlancoNameAdjuster;
import blanco.db.common.stringgroup.BlancoDbLoggingModeStringGroup;
import blanco.db.common.valueobject.BlancoDbSetting;
import blanco.db.expander.query.BlancoPerfomanceCommonUtil;

import java.util.List;

/**
 * blancoDbが共通的に利用するユーティリティクラス。
 *
 * このクラスが生成するクラスはblancoDbが生成したソースコードで利用されます
 *
 * @since 2020.09.04
 * @author tueda
 */
public class BlancoDbDynamicParameterClassJava {
    /**
     * このクラス自身のクラス名
     */
    public static final String CLASS_NAME = "BlancoDbDynamicParameter";

    /**
     * blancoCg オブジェクトファクトリ。
     */
    private BlancoCgObjectFactory fCgFactory = null;

    /**
     * このクラスが含まれるソースコード。
     */
    private BlancoCgSourceFile fCgSourceFile = null;

    private BlancoDbSetting fDbSetting = null;

    public BlancoDbDynamicParameterClassJava(final BlancoCgObjectFactory cgFactory,
                                             final String argPackage, final BlancoDbSetting argDbSetting) {
        fCgFactory = cgFactory;
        fCgSourceFile = fCgFactory.createSourceFile(argPackage,
                "This code is generated by blanco Framework.");

        this.fDbSetting = argDbSetting;
    }

    public BlancoCgSourceFile expand() {
        final BlancoCgClass cgClass = fCgFactory.createClass(CLASS_NAME, null);
        cgClass.setGenerics("T");
        fCgSourceFile.getClassList().add(cgClass);

        {
            final List<String> listDesc = cgClass.getLangDoc()
                    .getDescriptionList();

            listDesc.add("動的条件句に対するパラメータを定義するクラス。");
            listDesc.add("");
            listDesc.add("このクラスはblancoDbが生成したソースコードで利用されます <br>");
            listDesc.add("");
            listDesc.add("@since 2020.09.04");
            listDesc.add("@author blanco Framework");
        }

        {
            /* fields */
            cgClass.getFieldList().add(
                    buildField("key", "DynamicClause を引き当てるキー", "java.lang.String", null, null)
            );
            cgClass.getFieldList().add(
                    buildField("logicalOperator", "COMPARE動的条件句タイプを繰り返す際に接続に用いる論理演算子", "java.lang.String", null, "OR")
            );
            cgClass.getFieldList().add(
                    buildField("values", "PreparedStatement のプレースホルダに適用する値", "java.util.List", "T", null)
            );
        }

        {
            /* Getter/Setter */
            cgClass.getMethodList().add(
                    buildMethodSet("key", "DynamicClause を引き当てるキー", "java.lang.String", null)
            );
            cgClass.getMethodList().add(
                    buildMethodGet("key", "DynamicClause を引き当てるキー", "java.lang.String", null)
            );

            cgClass.getMethodList().add(
                buildMethodSet("logicalOperator", "COMPARE動的条件句タイプを繰り返す際に接続に用いる論理演算子", "java.lang.String", null)
            );
            cgClass.getMethodList().add(
                    buildMethodGet("logicalOperator", "COMPARE動的条件句タイプを繰り返す際に接続に用いる論理演算子", "java.lang.String", null)
            );

            cgClass.getMethodList().add(
                    buildMethodSet("values", "PreparedStatement のプレースホルダに適用する値", "java.util.List", "T")
            );
            cgClass.getMethodList().add(
                    buildMethodGet("values", "PreparedStatement のプレースホルダに適用する値", "java.util.List", "T")
            );
        }

        if (fDbSetting.getLogging()) {
            switch (fDbSetting.getLoggingMode()) {
            case BlancoDbLoggingModeStringGroup.PERFORMANCE:
            case BlancoDbLoggingModeStringGroup.SQLID:
                BlancoPerfomanceCommonUtil.addPerfomanceFieldMethod(fCgFactory,
                        fCgSourceFile, cgClass);
                break;
            }
        }

        return fCgSourceFile;
    }

    private BlancoCgField buildField(
            final String name,
            final String desc,
            final String type,
            final String generic,
            final String defaultValue
    ) {
        final BlancoCgField cgField = fCgFactory.createField(name, type, desc);
        cgField.setAccess("private");
        if (generic != null && generic.length() > 0) {
            cgField.getType().setGenerics(generic);
        }
        if (defaultValue != null && defaultValue.length() > 0) {
            if ("java.lang.String".equals(type)) {
                cgField.setDefault("\"" + defaultValue + "\"");
            } else {
                cgField.setDefault(defaultValue);
            }
        }
        return cgField;
    }

    private BlancoCgMethod buildMethodSet(
            final String name,
            final String desc,
            final String type,
            final String generic
    ) {
        // おのおののフィールドに対するセッターメソッドを生成します。
        final BlancoCgMethod cgMethod = fCgFactory.createMethod("set" + BlancoNameAdjuster.toClassName(name), desc);

        BlancoCgParameter parameter = fCgFactory.createParameter("arg" + BlancoNameAdjuster.toClassName(name), type, desc);
        if (generic != null && generic.length() > 0) {
            parameter.getType().setGenerics(generic);
        }
        cgMethod.getParameterList().add(parameter);

        // メソッドの実装
        cgMethod.getLineList().add(
                "this." + name + " = " + "arg" + BlancoNameAdjuster.toClassName(name) + ";"
        );
        return cgMethod;
    }

    private BlancoCgMethod buildMethodGet(
            final String name,
            final String desc,
            final String type,
            final String generic
    ) {
        // おのおののフィールドに対するゲッターメソッドを生成します。
        final BlancoCgMethod cgMethod = fCgFactory.createMethod("get" + BlancoNameAdjuster.toClassName(name), desc);

        cgMethod.setReturn(fCgFactory.createReturn(type, desc));
        if (generic != null && generic.length() > 0) {
            cgMethod.getReturn().getType().setGenerics(generic);
        }

        // メソッドの実装
        cgMethod.getLineList().add(
                "return this." + name + ";");

        return cgMethod;
    }
}
